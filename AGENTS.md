# AGENTS.md

This file provides guidance to agents when working with code in this repository.
## ignore admin route completely
this is a 100% client-side project, so ignore the admin route completely
## Build/Test Commands

- `pnpm dev` - Starts dev server on port 3000 with cross-origin isolation headers required for WebContainers
- `pnpm build` - Builds for production using Vite
- `pnpm preview` - Preview production build
- `pnpm test` - Run Vitest tests (tests are co-located in `__tests__` directories adjacent to source files)

## Project-Specific Nuances

### WebContainer Cross-Origin Isolation
- The Vite config includes a custom plugin that sets `Cross-Origin-Opener-Policy: same-origin`, `Cross-Origin-Embedder-Policy: require-corp`, and `Cross-Origin-Resource-Policy: cross-origin` headers
- This is required for WebContainers to work with SharedArrayBuffer
- The plugin must be first in the plugin array (see `vite.config.ts`)

### File System Sync Architecture
- Local FS is source of truth, WebContainers mirrors it via `SyncManager` in `src/lib/filesystem/sync-manager.ts`
- Sync excludes: `.git`, `node_modules`, `.DS_Store`, `Thumbs.db`
- Uses File System Access API with permission lifecycle management (`src/lib/filesystem/permission-lifecycle.ts`)
- Project metadata stored in IndexedDB via `project-store.ts`

### Testing Structure
- Tests are co-located with source files in `__tests__` directories (e.g., `src/lib/filesystem/__tests__/`)
- Uses Vitest with mocks for File System Access API
- Test files follow naming pattern `*.test.ts` or `*.test.tsx`

### Route Generation
- TanStack Router generates `src/routeTree.gen.ts` automatically
- VS Code settings mark this file as read-only and exclude from watcher/search
- Do not manually edit `routeTree.gen.ts`

### TypeScript Configuration
- Uses `verbatimModuleSyntax: false` (not strict ESM)
- Path alias `@/*` maps to `./src/*`
- Strict TypeScript with `noUnusedLocals` and `noUnusedParameters` enabled

### IDE Workspace Context
- Workspace state managed via React Context in `src/lib/workspace/WorkspaceContext.tsx`
- Uses TanStack Store for state management
- File operations go through `LocalFSAdapter` and `SyncManager`

## Code Style & Conventions

### Import Order
- React imports first
- Third-party libraries next
- Internal modules with `@/` alias
- Relative imports last

### Error Handling
- Custom error classes in `src/lib/filesystem/sync-types.ts` (`SyncError`, `PermissionDeniedError`, `FileSystemError`)
- Use `try/catch` with specific error types rather than generic Error

### Component Structure
- Components in `src/components/` organized by feature (ide/, ui/, layout/)
- Each component directory has `index.ts` barrel exports
- Use TypeScript interfaces for props with `interface` rather than `type` for better error messages

### File Naming
- PascalCase for React components and TypeScript types
- camelCase for utilities and hooks
- kebab-case for test files (e.g., `local-fs-adapter.test.ts`)

## Gotchas & Warnings

1. **WebContainer Singleton**: Only one WebContainer instance can be booted per page (singleton pattern in `src/lib/webcontainer/manager.ts`)
2. **FSA Permissions**: File System Access API permissions are ephemeral; use `permission-lifecycle.ts` utilities to manage persistence
3. **Route Tree**: Never edit `src/routeTree.gen.ts` directly; it's auto-generated by TanStack Router plugin
4. **Cross-Origin Headers**: Missing COOP/COEP headers will break WebContainers in dev mode
5. **Sync Exclusions**: `.git` and `node_modules` are excluded from sync to WebContainers (they'll be regenerated)
6. **IndexedDB Schema**: Project metadata schema is in `src/lib/workspace/project-store.ts`; changes require migration
7. **Test Mocks**: Tests mock `window.showDirectoryPicker` and File System Access API globally

## Development Workflow

1. **Starting**: Run `pnpm dev` (automatically sets required headers)
2. **Testing**: Run `pnpm test` for unit tests
3. **Building**: Run `pnpm build` (outputs to `dist/`)
4. **Preview**: Run `pnpm preview` to test production build locally

## Key Directories

- `src/lib/filesystem/` - File system sync and FSA utilities
- `src/lib/webcontainer/` - WebContainer lifecycle and process management
- `src/lib/workspace/` - Workspace state and project persistence
- `src/components/ide/` - Monaco editor, file tree, terminal, preview panel
- `src/routes/` - TanStack Router file-based routes
- `src/data/` - Demo data and fixtures